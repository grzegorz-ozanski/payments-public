name: Run payments

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
#  run-ubuntu:
#    runs-on: ubuntu-latest
#
#    steps:
#    - name: Checkout current repo
#      uses: actions/checkout@v4
#
#    - name: Clone browser repo
#      run: |
#        git clone https://x-access-token:${{ secrets.BROWSER_REPO_TOKEN }}@github.com/grzegorz-ozanski/browser.git
#
#    - name: Install GitHub CLI
#      uses: cli/cli-action@v2
#
#    - name: Download Chrome i Chromedriver from GitHub Release
#      run: |
#        CHROMEDRIVER_VERSION=chromedriver-chrome-134.0.6944.0
#        gh release download "${CHROMEDRIVER_VERSION}" \
#          --repo grzegorz-ozanski/chrome \
#          --pattern "${CHROMEDRIVER_VERSION}.zip"
#         unzip ${CHROMEDRIVER_VERSION}.zip
#      env:
#        GH_TOKEN: ${{ secrets.CHROME_REPO_TOKEN }}
#
#    - name: Set up Python
#      uses: actions/setup-python@v5
#      with:
#        python-version: '3.11'
#
#    - name: Install dependencies
#      run: |
#        python -m pip install --upgrade pip
#        pip install -r requirements.txt
#
#    - name: Add dependency to PYTHONPATH
#      run: echo "PYTHONPATH=$(pwd)/browser" >> $GITHUB_ENV
#
#    - name: Run the script
#      run: python main.py
#

  run-windows:
    runs-on: [self-hosted, Windows]

    steps:
    - name: Checkout current repo
      uses: actions/checkout@v4

    - name: Use system Python 3.11
      run: |
        $PYTHONPATH = "$env:USERPROFILE\AppData\Local\Programs\Python\Python311"
        echo "$PYTHONPATH" >> $env:GITHUB_PATH
        echo "$PYTHONPATH\Scripts" >> $env:GITHUB_PATH

    - name: Verify system Python 3.11
      run: |
        python --version
        where python

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt

    - name: Clone browser repo
      uses: actions/checkout@v4
      with:
        repository: grzegorz-ozanski/browser
        path: browser
        token: ${{ secrets.BROWSER_REPO_TOKEN }}

    - name: Download Chrome and Chromedriver from GitHub Release
      run: |
        $CHROMEDRIVER_VERSION = "chromedriver-chrome-134.0.6944.0"
        gh release download $CHROMEDRIVER_VERSION `
          --repo grzegorz-ozanski/chrome `
          --pattern "$CHROMEDRIVER_VERSION.zip"
        Expand-Archive -Path "$CHROMEDRIVER_VERSION.zip" -DestinationPath .
      env:
        GH_TOKEN: ${{ secrets.CHROME_REPO_TOKEN }}

    - name: Add dependency to PYTHONPATH
      run: echo "PYTHONPATH=$(pwd)/browser" >> $env:GITHUB_ENV

    - name: Prepare credentials
      run: |
        echo "${{ secrets.CREDENTIALS }}" >> $env:GITHUB_ENV

    - name: Run the script
      run: |
        python main.py

    - name: Upload error logs
      uses: actions/upload-artifact@v4
      with:
        name: error-logs
        path: |
          ./*.png
          ./*.html
